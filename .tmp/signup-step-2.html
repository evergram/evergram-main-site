<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>evergram main site</title>
  <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

  <!-- build:css styles/vendor.css -->
  <!-- bower:css -->
  <!-- endbower -->
  <!-- endbuild -->

  <!-- build:css styles/main.css -->
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild -->

  <!-- build:js scripts/vendor/modernizr.js -->
  <script src="/bower_components/modernizr/modernizr.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <!-- endbuild -->

  <script type="text/javascript">
    /* used throughout signup process to access querystring parameters */
    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
  </script>

</head>

<body>
<div class="container">
  <div class="header">
  <ul class="nav nav-pills pull-right">
    <li class="active"><a href="index.html">Home</a></li>
    <li class=""><a href="about.html">About</a></li>
  </ul>
  <h3 class="text-muted">Evergram</h3>
</div>


  <script src="https://js.stripe.com/v2/"></script>
<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.1/jquery.validate.min.js"></script>
<script>

	var MODE = "TEST";
	var API_ENDPOINT, SITE_URL;

	if( MODE == "TEST") {
		Stripe.setPublishableKey('pk_test_STOuGZQKq2LhVRLzSC8Qs3mJ');	// TEST KEY
		API_ENDPOINT = "//localhost:8080";
		SITE_URL = "//localhost:9000";
	}
    else {
    	Stripe.setPublishableKey('pk_live_QAuikbQoj5IyU9wdrUlXl62v');		//LIVE KEY
    	API_ENDPOINT = "//api.evergram.co";
		SITE_URL = "//www.evergram.co";
    }

    var userData;

    $(document).ready(function() {

    	if( (getParameterByName("p") === "") ) {
	      //window.location = SITE_URL + "/connect-failed";
	      return;
	    } 

	    if( MODE == "TEST") {

	    	// Hard code IG values as we don't access OAuth from local platform
		  	$("#IG_USERNAME").val("richard_obrien");
			$("#IG_ACCESS_TOKEN").val("3306421.2fd0517.baf6a957a7bf4633a4d994d43d8af64d");
			$("#PLAN").val(getParameterByName("p"));

	    } else {

	    	/* handle the callback from OAuth to capture access_token and username */
			OAuth.callback(function (error, success) {
			  	
				if (error) {
			      window.location = SITE_URL + "/connect-failed/?p=" + getParameterByName("p");
					return;
				}
				
				// store in hidden form fields
			  	$("#IG_USERNAME").val(success.user.username);
				$("#IG_ACCESS_TOKEN").val(success.access_token);
				$("#PLAN").val(getParameterByName("p"));

			});
		}

    	// define plan related messaging based on querystring value p
		if( getParameterByName("p") == "PAYG" ) {
			$("#plan-msg").html(
				"<p>You selected our <br/>" +
				"	<span style='font-size:22px; font-weight:bold'>Pay per photo plan</span><br/>" +
				"	$0.80 /photo + $2.00 Delivery fee</p>" +
				"<p>As a Pay per photo customer, your card will be debited at the end of the month based how many photos your tag. <strong>No photos? No charge.</strong> Simple. :)</p>"
				);
		} else {
			$("#plan-msg").html(
				"<p>You selected our <br/>" +
				"	<span style='font-size:22px; font-weight:bold'>Unlimited plan</span><br/>" +
				"	Unlimited photos for $9.99 /month<br/>" +
				"	Delivery included</p>" +
				"<p>As an Unlimited customer, your card will be debited $9.99 each month, starting today.</p>"
				);
		}

        //$("#payment-form").submit(function(event) {
		$("#payment-form").validate({
			rules: {
	            fname: "required",
	            lname: "required",
	            email: "required",
	            address: "required",
	            city: "required",
	            state: "required",
	            postcode: "required",
	            country: "required"
	        },
	        messages: {
	            fname: "Please enter your first name",
	            lname: "Please enter your last name",
	            email: "Please enter a valid email address",
	            address: "Enter your address",
	            city: "Enter your city",
	            state: "Enter your state",
	            postcode: "Enter your post code",
	            country: "Enter your country"
	        },
			invalidHandler: function(event, validator) {
			    // 'this' refers to the form
			    
			    var errors = validator.numberOfInvalids();
			    if (errors) {
			      var message = errors == 1
			        ? 'Whoa nelly... looks like you missed something. Might need to take another look.'
			        : 'Whoa nelly... looks like you missed a few things. Might need to take another look.';
			      $("#error-msg").html("<i class='fa fa-exclamation-triangle'></i> " + message);
			      $("#error-msg").show();
			      toggleSubmitButton("enable");
			    } else {
			      $("#error-msg").hide();
			    }
			},
			submitHandler: function(form) {
	            // disable the submit button to prevent repeated clicks
	            toggleSubmitButton("disable");
	            
	            // createToken returns immediately - the supplied callback submits the form if there are no errors
	            Stripe.createToken({
	                number: $('#card-number').val(),
	                cvc: $('#card-cvc').val(),
	                exp_month: $('#card-expiry-month').val(),
	                exp_year: $('#card-expiry-year').val()
	            }, stripeResponseHandler);
	            return false; // submit is done from callback
        	}
        });
    });

    function stripeResponseHandler(status, response) {
        
    	try {
	        console.log("Stripe Token Created");

	        if (response.error) {
	            // show the stripe errors on the form
	            $("#error-msg").html("<i class='fa fa-exclamation-triangle'></i> Whoa nelly... " + response.error.message + " Might need to take another look.");
			      $("#error-msg").show();
				toggleSubmitButton("enable");
	        } else {
	            console.log('Sending POST Request...');

	            $.post(
	                API_ENDPOINT + '/user/',
	                {
	                    stripeToken : response.id,
	                	plan : $("#PLAN").val(),
	                    fname : $("#fname").val(),
	                    lname : $("#lname").val(),
	                    email : $("#email").val(),
	                    address : $("#address").val(),
	                    city : $("#city").val(),
	                    state : $("#state").val(),
	                    postcode : $("#postcode").val(),
	                    country : $("#country").val()
	                })
					.fail(function(data) {

					   	console.log( data );
						$('#error-msg').html("<i class='fa fa-exclamation-triangle'></i> Uh oh... looks like something went wrong.<br>" + showErrors(JSON.parse(data.responseText)) + "<br><br>If this is something you need help with, please feel free to contact us on <a href='mailto:help@evergram.co' target='_blank'>help@evergram.co</a>.");
			      		$("#error-msg").show();

				        console.log("response complete");
				        toggleSubmitButton("enable");
					})
					.done(function(data) {

	                	//success
					    console.log('...POST Success.');
	                    window.location = SITE_URL + "/signup-complete";
	                    console.log("response complete");
				        toggleSubmitButton("enable");
			      		$("#error-msg").hide();
					});
	        }
	    } catch (err) {
	    	// user data isn't complete so throw an error.
			$('#error-msg').html("<i class='fa fa-exclamation-triangle'></i> Uh oh... looks like something went wrong. Please contact us for help on <a href='mailto:help@evergram.co' target='_blank'>help@evergram.co</a> quoting this message...<br>" + err);
			$("#error-msg").show();
			console.log("response complete");
			toggleSubmitButton("enable");
	    }
    }

function toggleSubmitButton(state) {

	if(state === "disable") {

		$('.submit-button').attr("disabled", "disabled").html($('.submit-button').attr("data-loading-text"));
	} else {
        // re-enable the submit button
        $('.submit-button').removeAttr("disabled").html("Submit Card details");
    }
}

function showErrors(data) {

	var returnVal = "<ul>";
	alert(data.length);
	for( var i=0; i < data.length; i++ ) {
		returnVal += "<li>" + data[i].msg + "</li>";
	}
	return returnVal + "</ul>";
}

</script>

<style>
.submit-button[disabled="disabled"] {
	background-color: rgba(128,128,128,.5);
	box-shadow: none;
}
.submit-button[disabled="disabled"]:hover {
	background-color: rgba(128,128,128,.5);
	box-shadow: none;
}
#error-msg {
	display: none;
	margin-top:30px;
	font-weight:bold; 
	color: #f00;
	padding: 20px; 
	background-color: #FFE6E7;
	border: 1px solid #f00;
	border-radius: 3px;
}
.title {
	padding-bottom: 10px;
}
.error {
	color:#f00;
}
</style>
<div class="sqs-block form-block sqs-block-form">
	<div class="sqs-block-content">
		<div class="form-wrapper">
			<div class="form-inner-wrapper">

				<form id="payment-form">

					<input type="hidden" id="IG_USERNAME">
					<input type="hidden" id="IG_ACCESS_TOKEN">
					<input type="hidden" id="PLAN">

					<h3>A little about you...</h3>
					<div class="field-list clear">

						<fieldset class="form-item fields name required">
		                <div class="title">Your name <span class="required">*</span></div>
		                <legend>Your name</legend>
		                
		                  <div class="field first-name">
		                    <label class="caption">First Name
		                    <input class="field-element field-control" id="fname" name="fname" x-autocompletetype="given-name" type="text" spellcheck="false" maxlength="30" data-title="First" required>
		                    </label>
		                  </div>
		                  <div class="field last-name">
		                    <label class="caption">Last Name<input class="field-element field-control" id="lname" name="lname" x-autocompletetype="surname" type="text" spellcheck="false" maxlength="30" data-title="Last" required>
		                    </label>
		                  </div>
		                </fieldset>
						<div class="form-item field text required">
		                  <label class="title" for="email">Email address <span class="required">*</span></label>
		                  <input class="field-element text" type="text" id="email" name="email" required>
		                </div>
					</div>

					<h3>Where should we send your photos?</h3>
					<div class="field-list clear">
						<fieldset id="address-yui_3_17_2_1_1422249252089_41246" class="form-item fields address required">
		                  <div class="title">Your Address <span class="required">*</span></div>
		                  <legend>Your Address</legend>
		                  
		                  <div class="field address1">
		                    <label class="caption">Address<input class="field-element field-control" id="address" name="address" x-autocompletetype="address-line1" type="text" spellcheck="false" data-title="Street address">
		                    </label>
		                  </div>
		                  <div class="field city">
		                    <label class="caption">City<input class="field-element field-control" id="city" name="city" x-autocompletetype="city" type="text" spellcheck="false" data-title="City">
		                    </label>
		                  </div>
		                  <div class="field state-province">
		                    <label class="caption">State<input class="field-element field-control" id="state" name="state" x-autocompletetype="state" type="text" spellcheck="false" data-title="State">
		                    </label>
		                  </div>
		                  <div class="field zip">
		                    <label class="caption">Post Code/Zip<input class="field-element field-control" id="postcode" name="postcode" x-autocompletetype="postal-code" type="text" spellcheck="false" data-title="Postcode">
		                    </label>
		                  </div>
		                  <div class="field country">
		                    <label class="caption">Country<input class="field-element field-control" id="country" name="country" x-autocompletetype="country" type="text" spellcheck="false" data-title="Country">
		                    </label>
		                  </div>
		                </fieldset>
		            </div>

					<h3>How should we bill you?</h3>
					<div class="field-list clear">

						<div class="form-item field text required">
					    	<label class="title" for="card-number">Card Number <span class="required">*</span></label>
					        <input class="field-element text" type="text" size="20" autocomplete="off" id="card-number">
					    </div>
					    <div class="form-item field text required">
					    	<label class="title" for="card-cvc">Security code (CVC) <span class="required">*</span></label>
					        <input class="field-element text" type="text" size="20" autocomplete="off" id="card-cvc">
					    </div>

					    <fieldset class="form-item fields name required">
						    <div class="title">Expiration (MM/YYYY) <span class="required">*</span></div>
						    <legend>Expiration (MM/YYYY)</legend>
						    
								<div class="field first-name">
									<input class="field-element field-control" type="text" size="2" placeholder="MM" id="card-expiry-month">
								</div>
								<div class="field last-name">
									<input class="field-element field-control" type="text" size="4" placeholder="YYYY" id="card-expiry-year">
								</div>
					    </fieldset>

						<div id="plan-msg" style="text-align:center"></div>
                      	<!-- to display errors returned by createToken -->
						<div id="error-msg"></div>

					    <div class="sqs-block button-block sqs-block-button">
					    	<div class="sqs-block-content">
								<div class="sqs-block-button-container--center">
									<button type="submit" class="submit-button sqs-block-button-element--medium sqs-block-button-element" data-loading-text="<i class='fa fa-spinner fa-pulse'></i> Checking Card details...">Complete signup</button>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

  <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
  (function (b, o, i, l, e, r) {
    b.GoogleAnalyticsObject = l;
    b[l] || (b[l] =
      function () {
        (b[l].q = b[l].q || []).push(arguments)
      });
    b[l].l = +new Date;
    e = o.createElement(i);
    r = o.getElementsByTagName(i)[0];
    e.src = '//www.google-analytics.com/analytics.js';
    r.parentNode.insertBefore(e, r)
  }(window, document, 'script', 'ga'));
  ga('create', 'UA-XXXXX-X');
  ga('send', 'pageview');
</script>

<!-- build:js scripts/vendor.js -->
<!-- bower:js -->
<!--script src="/bower_components/jquery/dist/jquery.js"></script-->
<!-- endbower -->
<!-- endbuild -->

<!-- build:js scripts/plugins.js -->
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/affix.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/alert.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/dropdown.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/tooltip.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/modal.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/transition.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/button.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/popover.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/carousel.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/scrollspy.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/collapse.js"></script>
<script src="/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap/tab.js"></script>
<!-- endbuild -->

<!-- build:js scripts/main.js -->
<!--script src="scripts/main.js"></script-->
<!-- endbuild -->

</body>
</html>